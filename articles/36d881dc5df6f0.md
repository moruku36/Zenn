---
title: "Chat GPT ã‚’ä½¿ã£ã¦KQL ã‚’æ›¸ãã¨æ¥½ã ã‚ˆ"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Azure, ChatGPT, KQL]
published: true
---

## ã‚„ã‚ŠãŸã„ã“ã¨
æœ€è¿‘æ¥­å‹™ã§ã‚‚ã‚ˆãã‚„ã£ã¦ã¾ã™ãŒã€KQLã‚’ChatGPTã§ç”Ÿæˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚  

KQL ã¨ã¯ã€Kusto Query Language ã®ç•¥ã§ã€Azure Data Explorer ã‚„ Azure Monitor ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã—ãŸã‚Šåˆ†æã—ãŸã‚Šã™ã‚‹ãŸã‚ã®è¨€èªã§ã™ã€‚  

SQL ã«ä¼¼ãŸæ§‹æ–‡ã‚’æŒã¡ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„åˆ—ãªã©ã®ã‚¹ã‚­ãƒ¼ãƒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚  

ã¾ãŸã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åˆ¶é™ã€æ¼”ç®—å­ãªã©ã‚’ä½¿ã£ã¦è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ã§ã¯ã€å®Ÿè£…æ‰‹é †ã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰é›†ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## æ¦‚è¦
Azure ã§ KQL ã‚’æ›¸ãã«ã¯ã€ã¾ãš Azure Data Explorer ã‚„ Azure Monitor ãªã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œãã‚Œã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯ã€KQL ã‚’å®Ÿè¡Œã§ãã‚‹ Web ãƒ™ãƒ¼ã‚¹ã®ãƒ„ãƒ¼ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãŸã¨ãˆã°ã€Azure Data Explorer ã§ã¯ Kusto.Explorer ã‚„ Kusto.WebExplorerã€Azure Monitor ã§ã¯ Log Analytics ã‚„ Application Insights ãªã©ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ã€ã‚¯ã‚¨ãƒªã‚¨ãƒ‡ã‚£ã‚¿ã« KQL ã‚’å…¥åŠ›ã—ã€å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€ã‚¯ã‚¨ãƒªçµæœã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚

ã¾ãŸã€KQL ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚  

Azure Data Explorer ã‚„ Azure Monitor ã¯ REST API ã‚’æä¾›ã—ã¦ãŠã‚Šã€HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ KQL ã‚’é€ä¿¡ã—ã€JSON å½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ ã€‚  

ã•ã‚‰ã«ã€.NET ã‚„ Java ãªã©ã®è¨€èªç”¨ã® SDK ã‚‚æä¾›ã•ã‚Œã¦ãŠã‚Šã€ã‚³ãƒ¼ãƒ‰å†…ã§ KQL ã‚’çµ„ã¿ç«‹ã¦ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ ã€‚  

## Chat GPTã®ä½¿ã„æ–¹. 
Chat GPTã«æ›¸ã„ã¦ã‚‚ã‚‰ã„ãŸã„ã‚¯ã‚¨ãƒªã‚’æ—¥æœ¬èªã§èª¬æ˜ã—ã¾ã™ã€‚  

KQLã§ã©ã†ã„ã†æ“ä½œãŒã§ãã‚‹ã®ã‹ã€äº‹å‰çŸ¥è­˜ãŒå¿…è¦ã§ã™ãŒã€ã‚¢ãƒã‚¦ãƒˆã«ãŠé¡˜ã„ã—ã¦ã‚‚ã‚¯ã‚¨ãƒªã‚’æ›¸ã„ã¦ãã‚Œã¾ã™ã€‚  

ç”Ÿæˆä¾‹ã¯ä»¥ä¸‹ã§ã™ã€‚  

![image1](/images/36d881dc5df6f0/Screenshot%202023-03-26%20at%2010.26.17)


## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰é›†
ã“ã“ã§ã¯ã€Azure Monitor, Azure Firewall , Sentinel ã§åˆ©ç”¨ã™ã‚‹ä¾‹ã‚’ãã‚Œãã‚Œç¤ºã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€KQL ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚„ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚¹ãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ãŸã‚Šå¯è¦–åŒ–ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ ã€‚

### Azure Monitor
Azure Monitor ã§ã¯ã€KQL ã‚’ä½¿ã£ã¦ Azure ãƒªã‚½ãƒ¼ã‚¹ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„çŠ¶æ…‹ã‚’ç›£è¦–ã—ãŸã‚Šã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€Azure Monitor ã® Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§å®Ÿè¡Œã§ãã‚‹ KQL ã®ä¾‹ã§ã™ã€‚

- VM ã® CPU ä½¿ç”¨ç‡ã®å¹³å‡å€¤ã¨æœ€å¤§å€¤ã‚’æ™‚ç³»åˆ—ã§è¡¨ç¤ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
Perf
| where ObjectName == "Processor" and CounterName == "% Processor Time"
| summarize avg(CounterValue), max(CounterValue) by bin(TimeGenerated, 1h), Computer
| render timechart
```

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾‹å¤–æ•°ã¨ç¨®é¡ã‚’é›†è¨ˆã—ã¦è¡¨ç¤ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
exceptions
| summarize count() by type, bin(timestamp, 1d)
| render barchart
```

- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®é€å—ä¿¡ãƒã‚¤ãƒˆæ•°ã‚’è¡¨ç¤ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
Perf
| where ObjectName == "Network Adapter" and (CounterName == "Bytes Received/sec" or CounterName == "Bytes Sent/sec")
| summarize sum(CounterValue) by CounterName, bin(TimeGenerated, 1h)
| render timechart
```

### Azure Firewall
Azure Firewall ã§ã¯ã€KQL ã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ãƒ­ã‚°ã‚’åˆ†æã—ãŸã‚Šã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚„è„…å¨ã®å‚¾å‘ã‚’æŠŠæ¡ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€Azure Firewall ã®ãƒ­ã‚°ã‚’åé›†ã™ã‚‹ Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§å®Ÿè¡Œã§ãã‚‹ KQL ã®ä¾‹ã§ã™ã€‚

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã£ã¦è¨±å¯ã•ã‚ŒãŸãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®æ•°ã¨é‡ã‚’è¡¨ç¤ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
AzureDiagnostics
| where ResourceType == "AZUREFIREWALLS" and Category == "AzureFirewallApplicationRule"
| where msg_s contains "Action: Allow"
| summarize count(), sum(BytesSent_d + BytesReceived_d) by bin(TimeGenerated, 1h)
| render timechart
```

### Sentinel
Sentinel ã§ã¯ã€KQL ã‚’ä½¿ã£ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ãŸã‚Šã€æ¤œå‡ºãƒ«ãƒ¼ãƒ«ã‚„ãƒ–ãƒƒã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€Sentinel ã®ãƒ­ã‚°ã‚’åé›†ã™ã‚‹ Log Analytics ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§å®Ÿè¡Œã§ãã‚‹ KQL ã®ä¾‹ã§ã™ã€‚

- ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®å¤±æ•—å›æ•°ã¨åŸå› ã‚’è¡¨ç¤ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
SigninLogs
| where ResultType !in ("0", "50125", "50140")
| summarize count() by ResultType, ResultDescription
| render piechart
```

- ãƒãƒ«ã‚¦ã‚§ã‚¢ã«æ„ŸæŸ“ã—ãŸãƒ‡ãƒã‚¤ã‚¹ã®æ•°ã¨ç¨®é¡ã‚’è¡¨ç¤ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
DeviceTvmSoftwareInventory
| where ThreatStatusRank == 1
| summarize count() by DeviceName, ThreatName
| render barchart
```

- ç•°å¸¸ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ¤œå‡ºã™ã‚‹KQLã‚’æ›¸ã„ã¦ãã ã•ã„
```kql
let threshold = 5;
let timeframe = 1d;
NetworkCommunicationEvents
| where CommunicationDirection == "Outbound"
| where TimeGenerated > ago(timeframe)
| summarize Dcount = dcount(RemoteUrl) by DeviceId, bin(TimeGenerated, 1h)
| where Dcount > threshold
| project TimeGenerated, DeviceId, Dcount
```

ä»¥ä¸ŠãŒã€Azure ã§ KQL ã‚’æ›¸ãæ–¹æ³•ã«ã¤ã„ã¦ã®ç´¹ä»‹ã§ã™ã€‚
KQL ã¯ã€Azure ã®ã•ã¾ã–ã¾ãªã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«æ¢ç´¢ã—ãŸã‚Šåˆ†æã—ãŸã‚Šã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ãœã²ã€KQL ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚

## å‚è€ƒã‚µã‚¤ãƒˆ

https://learn.microsoft.com/ja-jp/sharepoint/dev/general-development/keyword-query-language-kql-syntax-reference
